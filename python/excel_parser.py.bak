#!/usr/bin/env python3
"""
Excel to PostgreSQL Importer
à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Excel à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆ PostgreSQL Database
"""

import sys
import pandas as pd
import psycopg2
from datetime import datetime
import os

# Load environment variables
load_dotenv()

# Database configuration
DB_CONFIG = {
    'host': os.getenv('DB_HOST', 'localhost'),
    'port': os.getenv('DB_PORT', '5432'),
    'database': os.getenv('DB_NAME', 'forensic_hr'),
    'user': os.getenv('DB_USER', 'postgres'),
    'password': os.getenv('DB_PASSWORD', 'postgres')
}

# Column mapping (Excel column -> Database column)
COLUMN_MAPPING = {
    'à¸¢à¸¨': 'rank',
    'à¹€à¸à¸¨': 'gender',
    'à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥': 'full_name',
    'à¸Šà¸·à¹ˆà¸­': 'first_name',
    'à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥': 'last_name',
    'à¸Šà¸·à¹ˆà¸­à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡': 'position',
    'à¹€à¸¥à¸‚à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡': 'position_code',  # âœ¨ à¹ƒà¸«à¸¡à¹ˆ
    'à¹€à¸¥à¸‚à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹ƒà¸«à¸¡à¹ˆ': 'position_code',  # âœ¨ à¹ƒà¸«à¸¡à¹ˆ (à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£)
    'à¹€à¸¥à¸‚à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¹€à¸”à¸´à¸¡': 'old_position_code',  # âœ¨ à¹ƒà¸«à¸¡à¹ˆ
    'à¹€à¸¥à¸‚à¸šà¸±à¸•à¸£à¸›à¸£à¸°à¸Šà¸²à¸Šà¸™': 'national_id',  # âœ¨ à¹ƒà¸«à¸¡à¹ˆ
    'à¸ªà¸±à¸‡à¸à¸±à¸”': 'department',
    'à¸§à¹ˆà¸²à¸‡': 'status',
    'à¸§à¸±à¸™à¹à¸•à¹ˆà¸‡à¸•à¸±à¹‰à¸‡à¸„à¸£à¸±à¹‰à¸‡à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢': 'appointed_date',
    'à¸£à¸°à¸”à¸±à¸šà¸™à¸µà¹‰à¹€à¸¡à¸·à¹ˆà¸­': 'level_date',
    'à¸§à¸±à¸™à¸šà¸£à¸£à¸ˆà¸¸': 'hire_date',  # à¸›à¸£à¸°à¸—à¸§à¸™
    'à¸§à¸±à¸™à¸šà¸£à¸£à¸ˆà¸¸à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£': 'hire_date',  # à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£
    'à¸§à¸”à¸›.à¹€à¸à¸´à¸”': 'birth_date',
    'à¸„à¸¸à¸“à¸§à¸¸à¸’à¸´': 'education',
    'à¸ à¸¹à¸¡à¸´à¸¥à¸³à¹€à¸™à¸²': 'hometown',
    'à¸à¸¥à¸¸à¹ˆà¸¡à¸ªà¸²à¸¢à¸‡à¸²à¸™': 'new_department_group',  # à¸›à¸£à¸°à¸—à¸§à¸™
    'à¸à¸¥à¸¸à¹ˆà¸¡à¸ªà¸²à¸¢à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ': 'new_department_group',  # à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£
    'à¸ªà¸²à¸¢à¸‡à¸²à¸™': 'new_work_line',  # à¸›à¸£à¸°à¸—à¸§à¸™
    'à¸ªà¸²à¸¢à¸‡à¸²à¸™à¹ƒà¸«à¸¡à¹ˆ': 'new_work_line',  # à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£
    'à¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ': 'new_duty',  # à¸›à¸£à¸°à¸—à¸§à¸™
    'à¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹ƒà¸«à¸¡à¹ˆ': 'new_duty',  # à¸ªà¸±à¸à¸à¸²à¸šà¸±à¸•à¸£
    'à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¹à¸•à¹ˆà¸‡à¸•à¸±à¹‰à¸‡': 'appointment_order',
    'à¹€à¸à¸©à¸µà¸¢à¸“': 'retirement_date',
    'à¸šà¸.': 'headquarters',
    'à¸£à¸°à¸”à¸±à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡': 'position_level',
    'à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ': 'duty',
    'à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸”à¸´à¸¡': 'duty',  # à¸›à¸£à¸°à¸—à¸§à¸™
    'à¸¥à¸³à¸”à¸±à¸š': 'sequence_number',
    'à¸„à¸¸à¸“à¸§à¸¸à¸’à¸´à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸£à¸°à¸”à¸±à¸š': 'promotion_education',
    'à¸«à¸¥à¸±à¸à¸ªà¸¹à¸•à¸£à¹€à¸›à¹‡à¸™à¸•à¸³à¸£à¸§à¸ˆ': 'police_course'
}

def clean_data(value):
    """à¸—à¸³à¸„à¸§à¸²à¸¡à¸ªà¸°à¸­à¸²à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥"""
    if pd.isna(value) or value == '' or str(value).lower() in ['nan', 'nat', 'none']:
        return None
    return str(value).strip()

def parse_date(date_str):
    """à¹à¸›à¸¥à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ"""
    if pd.isna(date_str) or date_str == '' or str(date_str) == 'NaT':
        return None
    
    try:
        # à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™ datetime object à¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§
        if isinstance(date_str, datetime):
            return date_str.strftime('%Y-%m-%d')
        
        # à¹à¸›à¸¥à¸‡à¸ˆà¸²à¸ string
        date_str = str(date_str)
        
        # à¸¥à¸­à¸‡à¸«à¸¥à¸²à¸¢à¸£à¸¹à¸›à¹à¸šà¸š
        formats = ['%Y-%m-%d', '%d/%m/%Y', '%Y-%m-%d %H:%M:%S']
        for fmt in formats:
            try:
                dt = datetime.strptime(date_str, fmt)
                return dt.strftime('%Y-%m-%d')
            except:
                continue
        
        return None
    except:
        return None

def import_excel_to_db(excel_file):
    """à¸™à¸³à¹€à¸‚à¹‰à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Excel à¹€à¸‚à¹‰à¸² PostgreSQL"""
    
    try:
        print(f"ğŸ“‚ Reading Excel file: {excel_file}")
        
        # à¸­à¹ˆà¸²à¸™à¹„à¸Ÿà¸¥à¹Œ Excel
        df = pd.read_excel(excel_file)
        print(f"âœ… Loaded {len(df)} rows from Excel")
        
        # à¹à¸ªà¸”à¸‡ columns
        print(f"ğŸ“‹ Columns: {list(df.columns)}")
        
        # à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Database
        print(f"ğŸ”Œ Connecting to database...")
        conn = psycopg2.connect(**DB_CONFIG)
        cursor = conn.cursor()
        print(f"âœ… Database connected")
        
        # à¸¥à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¹ˆà¸² (optional - comment out à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸¥à¸š)
        # cursor.execute("TRUNCATE TABLE personnel RESTART IDENTITY CASCADE")
        # print("ğŸ—‘ï¸  Cleared old data")
        
        # Insert data
        insert_count = 0
        error_count = 0
        
        for index, row in df.iterrows():
            try:
                # à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
                data = {}
                for excel_col, db_col in COLUMN_MAPPING.items():
                    if excel_col in df.columns:
                        value = row[excel_col]
                        
                        # à¹à¸›à¸¥à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ
                        if db_col in ['appointed_date', 'hire_date', 'birth_date', 'retirement_date']:
                            data[db_col] = parse_date(value)
                        elif db_col == 'level_date':
                            # level_date à¹€à¸›à¹‡à¸™ timestamp
                            date_val = parse_date(value)
                            data[db_col] = date_val if date_val else None
                        else:
                            data[db_col] = clean_data(value)
                
                # à¸ªà¸£à¹‰à¸²à¸‡ SQL query
                columns = list(data.keys())
                values = list(data.values())
                placeholders = ', '.join(['%s'] * len(values))
                columns_str = ', '.join(columns)
                
                sql = f"INSERT INTO personnel ({columns_str}) VALUES ({placeholders})"
                cursor.execute(sql, values)
                
                insert_count += 1
                
                # à¹à¸ªà¸”à¸‡à¸„à¸§à¸²à¸¡à¸„à¸·à¸šà¸«à¸™à¹‰à¸²
                if (insert_count % 100 == 0):
                    print(f"â³ Imported {insert_count} rows...")
                    
            except Exception as e:
                error_count += 1
                print(f"âš ï¸  Error at row {index + 1}: {str(e)}")
                continue
        
        # Commit changes
        conn.commit()
        
        print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ“Š Import Summary                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Successfully imported: {insert_count} rows
âš ï¸  Errors: {error_count} rows
ğŸ“ˆ Total rows processed: {len(df)} rows
        """)
        
        # Close connection
        cursor.close()
        conn.close()
        
        return True
        
    except Exception as e:
        print(f"âŒ Error: {str(e)}")
        return False

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python excel_parser.py <excel_file>")
        sys.exit(1)
    
    excel_file = sys.argv[1]
    
    if not os.path.exists(excel_file):
        print(f"âŒ File not found: {excel_file}")
        sys.exit(1)
    
    success = import_excel_to_db(excel_file)
    sys.exit(0 if success else 1)
