name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_CONTAINER_APP: forensic-hr-app
  RESOURCE_GROUP: rg-forensic-hr
  ACR_NAME: forensichracr
  IMAGE_NAME: forensic-hr

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üîê Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: üê≥ Login to ACR
      run: |
        echo ${{ secrets.ACR_PASSWORD }} | docker login ${{ env.ACR_NAME }}.azurecr.io \
          --username ${{ secrets.ACR_USERNAME }} \
          --password-stdin
    
    - name: üèóÔ∏è Build Docker image
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        echo "IMAGE_TAG=${TIMESTAMP}" >> $GITHUB_ENV
        docker build --no-cache --platform linux/amd64 \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${TIMESTAMP} \
          .
    
    - name: üì§ Push to ACR
      run: |
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
    
    - name: üöÄ Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
    
    - name: ‚è≥ Wait for deployment
      run: sleep 30
    
    - name: ‚úÖ Verify deployment
      run: |
        az containerapp revision list \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query "[-1].{name:name, replicas:properties.replicas, health:properties.healthState}" \
          -o table
    
    - name: üìä Get URL
      run: |
        URL=$(az containerapp show \
          --name ${{ env.AZURE_CONTAINER_APP }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          -o tsv)
        echo "üåê Application URL: https://${URL}"
