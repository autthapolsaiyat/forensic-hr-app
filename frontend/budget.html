<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏•‡∏á‡∏ó‡∏∏‡∏ô - ‡∏™‡∏û‡∏ê.‡∏ï‡∏£.</title>
    <style>
        :root {
            --bg-primary: #1a5276;
            --bg-secondary: #2980b9;
            --bg-card: #2471a3;
            --text-primary: #ffffff;
            --text-secondary: #d4e6f1;
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --accent-red: #e74c3c;
        }

        [data-theme="light"] {
            --bg-primary: #e8f0f5;
            --bg-secondary: #f0f4f7;
            --bg-card: #ffffff;
            --bg-stat: #d6eaf8;
            --text-primary: #1a5276;
            --text-secondary: #5a7a9a;
            --border-color: #c5d9e8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Sarabun', 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            background: var(--bg-card);
            border-radius: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        [data-theme="light"] .header {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            border-top: 4px solid #3498db;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }

        .logo {
            width: 70px; height: 70px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px;
        }

        .header-title h1 { font-size: 32px; font-weight: bold; }
        .header-title p { font-size: 16px; color: var(--text-secondary); }

        .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }

        .nav-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn.primary { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .nav-btn.secondary { background: rgba(255,255,255,0.2); color: var(--text-primary); }
        .nav-btn:hover { transform: translateY(-2px); }

        .section {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        [data-theme="light"] .section {
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 3px solid #3498db;
        }

        .section-title { font-size: 24px; font-weight: bold; display: flex; align-items: center; gap: 10px; }

        .year-filter { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .year-filter label { color: var(--text-secondary); font-size: 14px; font-weight: bold; }

        .year-select {
            padding: 10px 15px;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            cursor: pointer;
            min-width: 100px;
        }

        .year-select:focus { outline: none; border-color: #3498db; }
        .year-select option { background: var(--bg-primary); color: var(--text-primary); }

        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover { transform: translateY(-2px); }
        .filter-btn.primary { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .filter-btn.secondary { background: rgba(255,255,255,0.2); color: var(--text-primary); }

        .year-info {
            text-align: center;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 25px;
        }

        [data-theme="light"] .year-info {
            background: var(--bg-stat);
        }

        .year-info strong { color: #3498db; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="light"] .stat-card {
            background: var(--bg-stat);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .stat-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.15); }
        [data-theme="light"] .stat-card:hover { background: #c9e2f5; }
        .stat-card.green { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stat-card.orange { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .stat-card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-card.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .stat-icon { font-size: 40px; margin-bottom: 10px; }
        .stat-label { font-size: 16px; color: var(--text-secondary); margin-bottom: 10px; }
        .stat-card.green .stat-label, .stat-card.orange .stat-label, .stat-card.blue .stat-label, .stat-card.red .stat-label { color: rgba(255,255,255,0.9); }
        .stat-number { font-size: 42px; font-weight: bold; }
        .stat-sub { font-size: 14px; margin-top: 5px; opacity: 0.8; }

        .amount-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .amount-card {
            border-radius: 15px;
            padding: 30px;
            text-align: center;
        }

        .amount-card.green { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .amount-card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }

        .amount-icon { font-size: 50px; margin-bottom: 15px; }
        .amount-number { font-size: 36px; font-weight: bold; }
        .amount-label { font-size: 18px; margin-top: 10px; opacity: 0.9; }

        .division-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .division-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="light"] .division-card {
            background: var(--bg-stat);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .division-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.15); }
        [data-theme="light"] .division-card:hover { background: #c9e2f5; }

        .division-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .division-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }

        .division-stat {
            text-align: center;
            padding: 12px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        [data-theme="light"] .division-stat {
            background: rgba(255,255,255,0.7);
        }

        .division-stat-icon { font-size: 20px; margin-bottom: 5px; }
        .division-stat-value { font-size: 20px; font-weight: bold; }
        .division-stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        [data-theme="light"] .status-card {
            background: var(--bg-stat);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .status-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.15); }
        [data-theme="light"] .status-card:hover { background: #c9e2f5; }
        .status-card.signed { border-left: 4px solid #27ae60; }
        .status-card.pending { border-left: 4px solid #f39c12; }

        .status-icon { font-size: 28px; margin-bottom: 8px; }
        .status-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .status-count { font-size: 28px; font-weight: bold; }

        .loading, .no-results { text-align: center; padding: 60px; font-size: 20px; color: var(--text-secondary); }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(180deg, var(--bg-primary), var(--bg-secondary));
            margin: 3% auto;
            padding: 30px;
            border-radius: 20px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
        }

        [data-theme="light"] .modal-content {
            background: var(--bg-secondary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        [data-theme="light"] .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-header h2 { font-size: 24px; }
        .modal-summary { 
            font-size: 16px; 
            color: var(--text-secondary); 
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        [data-theme="light"] .modal-summary {
            background: var(--bg-stat);
        }

        .modal-summary strong { color: var(--accent-green); }

        .close-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .close-btn:hover { background: #c0392b; transform: scale(1.05); }

        .modal-list { display: flex; flex-direction: column; gap: 15px; }

        .modal-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        [data-theme="light"] .modal-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .modal-item:hover { transform: translateX(5px); }

        .modal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 15px;
        }

        .modal-item-title { font-size: 15px; font-weight: bold; flex: 1; line-height: 1.4; }
        .modal-item-meta { font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; }

        .modal-item-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 13px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        [data-theme="light"] .modal-item-details {
            border-top-color: var(--border-color);
        }

        .modal-item-detail { display: flex; align-items: center; gap: 5px; }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .status-badge.signed { background: #27ae60; color: white; }
        .status-badge.pending { background: #f39c12; color: white; }

        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .stat-number { font-size: 32px; }
            .division-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 5% auto; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">üí∞</div>
                <div class="header-title">
                    <h1>‡∏á‡∏ö‡∏•‡∏á‡∏ó‡∏∏‡∏ô | ‡∏™‡∏û‡∏ê.‡∏ï‡∏£.</h1>
                    <p>Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏ö‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ</p>
                </div>
            </div>
            <div class="header-nav">
                <a href="/budget-search.html" class="nav-btn primary">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
                <a href="/" class="nav-btn secondary">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
                <button class="nav-btn secondary" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î</span>
                </button>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h2 class="section-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="year-filter">
                    <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</label>
                    <select id="yearStart" class="year-select"><option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option></select>
                    <span style="color: var(--text-secondary);">‡∏ñ‡∏∂‡∏á</span>
                    <select id="yearEnd" class="year-select"><option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</option></select>
                    <button class="filter-btn primary" onclick="applyYearFilter()">üîç ‡∏Å‡∏£‡∏≠‡∏á</button>
                    <button class="filter-btn secondary" onclick="resetYearFilter()">üîÑ ‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
            </div>
            <div class="year-info" id="yearInfo">üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</strong></div>
            <div class="stats-row" id="overviewStats">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
            <div class="amount-row" id="amountStats"></div>
        </div>

        <div class="section">
            <h2 class="section-title" style="margin-bottom: 25px;">üìà ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
            <div class="status-grid" id="statusGrid">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title" style="margin-bottom: 25px;">üèõÔ∏è ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</h2>
            <div class="division-grid" id="divisionGrid">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">-</h2>
                <button class="close-btn" onclick="closeModal()">‚úï ‡∏õ‡∏¥‡∏î</button>
            </div>
            <div class="modal-summary" id="modalSummary"></div>
            <div class="modal-list" id="modalList">
                <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            </div>
        </div>
    </div>

    <script>
        let statsData = null;
        let currentYearStart = '';
        let currentYearEnd = '';

        function formatNumber(num) {
            if (!num) return '0';
            return Number(num).toLocaleString('th-TH');
        }

        function formatAmount(num) {
            if (!num) return '0';
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            }
            return formatNumber(num);
        }

        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('budgetTheme', newTheme);
            document.getElementById('themeIcon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('themeText').textContent = newTheme === 'light' ? '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('budgetTheme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('themeIcon').textContent = 'üåô';
                document.getElementById('themeText').textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î';
            }
            loadYears();
            loadData();
        });

        async function loadYears() {
            try {
                const response = await fetch('/api/budget/years');
                const result = await response.json();
                if (result.success) {
                    const yearStart = document.getElementById('yearStart');
                    const yearEnd = document.getElementById('yearEnd');
                    result.data.forEach(year => {
                        yearStart.innerHTML += `<option value="${year}">${year}</option>`;
                        yearEnd.innerHTML += `<option value="${year}">${year}</option>`;
                    });
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function applyYearFilter() {
            currentYearStart = document.getElementById('yearStart').value;
            currentYearEnd = document.getElementById('yearEnd').value;
            if (currentYearStart && currentYearEnd && parseInt(currentYearStart) > parseInt(currentYearEnd)) {
                alert('‡∏õ‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }
            await loadData();
        }

        async function resetYearFilter() {
            document.getElementById('yearStart').value = '';
            document.getElementById('yearEnd').value = '';
            currentYearStart = '';
            currentYearEnd = '';
            await loadData();
        }

        function updateYearInfo(data) {
            const yearInfo = document.getElementById('yearInfo');
            let info = '';
            
            if (currentYearStart && currentYearEnd) {
                info = `üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>‡∏õ‡∏µ ${currentYearStart} - ${currentYearEnd}</strong>`;
            } else if (currentYearStart) {
                info = `üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>‡∏õ‡∏µ ${currentYearStart} ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ</strong>`;
            } else if (currentYearEnd) {
                info = `üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>‡∏ñ‡∏∂‡∏á‡∏õ‡∏µ ${currentYearEnd}</strong>`;
            } else {
                info = `üìÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: <strong>‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</strong>`;
            }
            
            if (data && data.yearsInRange) {
                info += ` | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong>${data.yearsInRange} ‡∏õ‡∏µ</strong>`;
                if (data.yearsList && data.yearsList.length > 0 && data.yearsList.length <= 5) {
                    info += ` (${data.yearsList.join(', ')})`;
                }
            }
            
            yearInfo.innerHTML = info;
        }

        async function loadData() {
            try {
                let params = new URLSearchParams();
                if (currentYearStart) params.append('yearStart', currentYearStart);
                if (currentYearEnd) params.append('yearEnd', currentYearEnd);
                
                const response = await fetch(`/api/budget/stats${params.toString() ? '?' + params.toString() : ''}`);
                const result = await response.json();
                
                if (result.success) {
                    statsData = result.data;
                    updateYearInfo(statsData);
                    renderOverviewStats(statsData);
                    renderAmountStats(statsData);
                    renderStatusGrid(statsData);
                    renderDivisionGrid(statsData);
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('overviewStats').innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>';
            }
        }

        function renderOverviewStats(data) {
            const container = document.getElementById('overviewStats');
            
            const stats = [
                { icon: 'üìã', label: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', value: data.total_records, sub: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', onclick: 'showAllItems()' },
                { icon: '‚úÖ', label: '‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', value: data.total_signed, sub: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', class: 'green', onclick: 'showSignedItems()' },
                { icon: '‚è≥', label: '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', value: data.total_pending, sub: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', class: 'orange', onclick: 'showPendingItems()' },
                { icon: 'üìù', label: '‡∏á‡∏ö‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', value: data.total_single_year, sub: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', onclick: "showByBudgetType('‡∏á‡∏ö‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß')" },
                { icon: 'üìë', label: '‡∏á‡∏ö‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô', value: data.total_multi_year, sub: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', onclick: "showByBudgetType('‡∏á‡∏ö‡∏ú‡∏π‡∏Å‡∏û‡∏±‡∏ô')" }
            ];
            
            container.innerHTML = stats.map(s => `
                <div class="stat-card ${s.class || ''}" onclick="${s.onclick}">
                    <div class="stat-icon">${s.icon}</div>
                    <div class="stat-label">${s.label}</div>
                    <div class="stat-number">${formatNumber(s.value)}</div>
                    <div class="stat-sub">${s.sub}</div>
                </div>
            `).join('');
        }

        function renderAmountStats(data) {
            const container = document.getElementById('amountStats');
            
            container.innerHTML = `
                <div class="amount-card green" onclick="showSignedItems()" style="cursor:pointer">
                    <div class="amount-icon">üí∞</div>
                    <div class="amount-number">${formatNumber(data.total_signed_amount)} ‡∏ö‡∏≤‡∏ó</div>
                    <div class="amount-label">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="amount-card blue" onclick="showSignedItems()" style="cursor:pointer">
                    <div class="amount-icon">üìä</div>
                    <div class="amount-number">${formatNumber(data.total_signed)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                    <div class="amount-label">‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÉ‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
            `;
        }

        function renderStatusGrid(data) {
            const container = document.getElementById('statusGrid');
            
            if (!data.byStatus || data.byStatus.length === 0) {
                container.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>';
                return;
            }

            const statusIcons = {
                'signed': '‚úÖ',
                'winner_announced': 'üìã',
                'appeal_period': '‚è≥',
                'announcement': 'üì¢',
                'tor_approval': 'üìù',
                'draft': 'üìÑ',
                'in_progress': 'üîÑ'
            };
            
            container.innerHTML = data.byStatus.map(s => {
                const icon = statusIcons[s.status_group] || 'üìã';
                let label = s.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const fullStatus = label;
                // Shorten label
                if (label.length > 20) {
                    label = label.substring(0, 20) + '...';
                }
                label = label.replace(/\n/g, ' ');
                
                return `
                    <div class="status-card ${s.status_group === 'signed' ? 'signed' : 'pending'}" onclick="showByStatus('${fullStatus.replace(/'/g, "\\'")}')">
                        <div class="status-icon">${icon}</div>
                        <div class="status-label">${label}</div>
                        <div class="status-count">${s.count}</div>
                    </div>
                `;
            }).join('');
        }

        function renderDivisionGrid(data) {
            const container = document.getElementById('divisionGrid');
            
            if (!data.byDivision || data.byDivision.length === 0) {
                container.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</div>';
                return;
            }
            
            container.innerHTML = data.byDivision.map(div => `
                <div class="division-card" onclick="showDivisionDetail('${div.division}')">
                    <div class="division-header">${div.division || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                    <div class="division-stats">
                        <div class="division-stat">
                            <div class="division-stat-icon">üìã</div>
                            <div class="division-stat-value">${div.count}</div>
                            <div class="division-stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                        </div>
                        <div class="division-stat">
                            <div class="division-stat-icon">‚úÖ</div>
                            <div class="division-stat-value">${div.signed_count}</div>
                            <div class="division-stat-label">‡∏•‡∏á‡∏ô‡∏≤‡∏°</div>
                        </div>
                        <div class="division-stat">
                            <div class="division-stat-icon">üí∞</div>
                            <div class="division-stat-value">${formatAmount(div.signed_amount)}</div>
                            <div class="division-stat-label">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== MODAL FUNCTIONS ====================

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: '2-digit' });
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        window.onclick = function(e) {
            if (e.target === document.getElementById('detailModal')) closeModal();
        }

        async function fetchAndShowModal(title, icon, params, summaryFn) {
            document.getElementById('detailModal').style.display = 'block';
            document.getElementById('modalTitle').innerHTML = `${icon} ${title}`;
            document.getElementById('modalSummary').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            document.getElementById('modalList').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            try {
                const queryParams = new URLSearchParams(params);
                queryParams.append('limit', '100');
                
                const response = await fetch(`/api/budget?${queryParams.toString()}`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    const totalAmount = data.reduce((sum, d) => sum + (parseFloat(d.contract_amount) || 0), 0);
                    const signedCount = data.filter(d => d.status_group === 'signed').length;
                    
                    document.getElementById('modalSummary').innerHTML = summaryFn(data, totalAmount, signedCount);
                    renderModalList(data);
                }
            } catch (error) {
                document.getElementById('modalList').innerHTML = '<div class="loading">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }

        function renderModalList(data) {
            const container = document.getElementById('modalList');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            container.innerHTML = data.map((item, idx) => `
                <div class="modal-item">
                    <div class="modal-item-header">
                        <div class="modal-item-title">
                            ${idx + 1}. ${item.project_type === '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£' ? 'üìÅ' : 'üìÑ'} ${item.project_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                        </div>
                        <span class="status-badge ${item.status_group === 'signed' ? 'signed' : 'pending'}">
                            ${item.status_group === 'signed' ? '‚úÖ ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ' + (item.status ? item.status.substring(0, 20) : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')}
                        </span>
                    </div>
                    <div class="modal-item-meta">
                        ${item.division || '-'} | ${item.category || '-'} | ${item.budget_type || '-'}
                    </div>
                    <div class="modal-item-details">
                        <div class="modal-item-detail">üí∞ ${item.contract_amount ? formatNumber(item.contract_amount) + ' ‡∏ö‡∏≤‡∏ó' : '‡∏£‡∏≠‡∏•‡∏á‡∏ô‡∏≤‡∏°'}</div>
                        <div class="modal-item-detail">üìÖ ‡∏•‡∏á‡∏ô‡∏≤‡∏°: ${formatDate(item.contract_date)}</div>
                        <div class="modal-item-detail">‚è∞ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${formatDate(item.end_date)}</div>
                        <div class="modal-item-detail">üè¢ ${item.contractor || '-'}</div>
                    </div>
                </div>
            `).join('');
        }

        // Show all items
        function showAllItems() {
            fetchAndShowModal('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'üìã', {}, 
                (data, totalAmount, signedCount) => `
                    üìä ‡∏£‡∏ß‡∏° <strong>${data.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                    ‚úÖ ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß <strong>${signedCount}</strong> | 
                    ‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ <strong>${data.length - signedCount}</strong> | 
                    üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <strong>${formatNumber(totalAmount)}</strong> ‡∏ö‡∏≤‡∏ó
                `
            );
        }

        // Show signed items
        function showSignedItems() {
            fetchAndShowModal('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß', '‚úÖ', { status_group: 'signed' },
                (data, totalAmount) => `
                    üìä ‡∏£‡∏ß‡∏° <strong>${data.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                    üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <strong>${formatNumber(totalAmount)}</strong> ‡∏ö‡∏≤‡∏ó
                `
            );
        }

        // Show pending items
        function showPendingItems() {
            fetchAndShowModal('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', '‚è≥', {},
                (data, totalAmount, signedCount) => {
                    const pendingData = data.filter(d => d.status_group !== 'signed');
                    return `üìä ‡∏£‡∏ß‡∏° <strong>${pendingData.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                }
            );
            // Override to filter pending
            setTimeout(async () => {
                const response = await fetch('/api/budget?limit=100');
                const result = await response.json();
                if (result.success) {
                    const pendingData = result.data.filter(d => d.status_group !== 'signed');
                    document.getElementById('modalSummary').innerHTML = `üìä ‡∏£‡∏ß‡∏° <strong>${pendingData.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                    renderModalList(pendingData);
                }
            }, 100);
        }

        // Show by budget type
        function showByBudgetType(budgetType) {
            const icon = budgetType === '‡∏á‡∏ö‡∏õ‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' ? 'üìù' : 'üìë';
            fetchAndShowModal(budgetType, icon, { budget_type: budgetType },
                (data, totalAmount, signedCount) => `
                    üìä ‡∏£‡∏ß‡∏° <strong>${data.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                    ‚úÖ ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß <strong>${signedCount}</strong> | 
                    üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <strong>${formatNumber(totalAmount)}</strong> ‡∏ö‡∏≤‡∏ó
                `
            );
        }

        // Show by division
        function showDivisionDetail(division) {
            fetchAndShowModal(division, 'üèõÔ∏è', { division: division },
                (data, totalAmount, signedCount) => `
                    üìä ‡∏£‡∏ß‡∏° <strong>${data.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                    ‚úÖ ‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß <strong>${signedCount}</strong> | 
                    ‚è≥ ‡∏£‡∏≠ <strong>${data.length - signedCount}</strong> | 
                    üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <strong>${formatNumber(totalAmount)}</strong> ‡∏ö‡∏≤‡∏ó
                `
            );
        }

        // Show by status
        function showByStatus(status) {
            document.getElementById('detailModal').style.display = 'block';
            document.getElementById('modalTitle').innerHTML = `üìà ${status.substring(0, 30)}...`;
            document.getElementById('modalSummary').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            document.getElementById('modalList').innerHTML = '<div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            fetch('/api/budget?limit=100')
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        const filtered = result.data.filter(d => d.status && d.status.includes(status.substring(0, 15)));
                        const totalAmount = filtered.reduce((sum, d) => sum + (parseFloat(d.contract_amount) || 0), 0);
                        document.getElementById('modalSummary').innerHTML = `
                            üìä ‡∏£‡∏ß‡∏° <strong>${filtered.length}</strong> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                            üí∞ ‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° <strong>${formatNumber(totalAmount)}</strong> ‡∏ö‡∏≤‡∏ó
                        `;
                        renderModalList(filtered);
                    }
                });
        }
    </script>
</body>
</html>
