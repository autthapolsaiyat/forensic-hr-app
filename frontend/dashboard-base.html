<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• - ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        
        tbody tr:hover {
            background-color: #f3f4f6;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .filter-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            min-width: 300px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-box {
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            width: 100%;
            max-width: 400px;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center text-white font-bold">
                        ‡∏ï‡∏£.
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</h1>
                        <p class="text-sm text-gray-600">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏¥‡∏ï‡∏¥‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏Å‡∏£‡∏°‡∏ï‡∏≥‡∏£‡∏ß‡∏à</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö: <span class="text-green-600 font-semibold">‚úì ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto px-6 py-8">
        
        <!-- Filter Section -->
        <div class="filter-box">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex-1">
                    <label class="block text-white font-semibold mb-2 text-lg">üîç ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                    <select id="sangkatFilter" class="filter-select" onchange="filterBySangkat()">
                        <option value="all">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div class="text-white">
                    <p class="text-sm opacity-90">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <p class="text-3xl font-bold" id="displayCount">0</p>
                    <p class="text-sm opacity-90">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="mb-8">
            
            <!-- Main Header with Logo -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-center space-x-8">
                    <div class="flex items-center space-x-4">
                        <div class="w-20 h-20 bg-gradient-to-br from-red-600 to-red-800 rounded-full flex items-center justify-center">
                            <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                            </svg>
                        </div>
                        <div class="text-center">
                            <h2 class="text-2xl font-bold text-gray-800">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</h2>
                            <p class="text-lg text-blue-600 font-semibold">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ï‡∏≥‡∏£‡∏ß‡∏à</p>
                            <p class="text-sm text-gray-500">Office of Forensic Science</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="bg-red-600 text-white px-6 py-3 rounded-lg inline-block">
                            <p class="text-3xl font-bold">üè†</p>
                            <p class="text-sm">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Stats Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-lg shadow-lg p-6">
                    <p class="text-blue-100 text-sm mb-2">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <h3 class="text-5xl font-bold mb-2" id="statTotal">0</h3>
                    <p class="text-blue-100 text-lg font-semibold">100 %</p>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white rounded-lg shadow-lg p-6">
                    <p class="text-green-100 text-sm mb-2">‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á</p>
                    <h3 class="text-5xl font-bold mb-2" id="statOccupied">0</h3>
                    <p class="text-green-100 text-lg font-semibold"><span id="statOccupiedPercent">0</span> %</p>
                </div>
                
                <div class="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-lg shadow-lg p-6">
                    <p class="text-yellow-100 text-sm mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á</p>
                    <h3 class="text-5xl font-bold mb-2" id="statVacant">0</h3>
                    <p class="text-yellow-100 text-lg font-semibold"><span id="statVacantPercent">0</span> %</p>
                </div>

                <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-lg shadow-lg p-6">
                    <p class="text-purple-100 text-sm mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏®</p>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-purple-100">‡∏ä‡∏≤‡∏¢</p>
                            <h3 class="text-3xl font-bold" id="statMale">0</h3>
                        </div>
                        <div>
                            <p class="text-sm text-purple-100">‡∏´‡∏ç‡∏¥‡∏á</p>
                            <h3 class="text-3xl font-bold" id="statFemale">0</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏¢‡∏® (Top 5)</h3>
                    <div id="rankStats" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üè¢ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Top 5)</h3>
                    <div id="sangkatStats" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Grid Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•</h2>
                <div class="flex items-center space-x-4">
                    <input type="text" id="searchBox" class="search-box" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... (‡∏ä‡∏∑‡πà‡∏≠, ‡∏¢‡∏®, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)" onkeyup="searchTable()">
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        üì• Export Excel
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="personnelTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>‡∏¢‡∏®</th>
                            <th>‡πÄ‡∏û‡∏®</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                            <th>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏</th>
                            <th>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="9" class="text-center py-8">
                                <div class="loading mx-auto"></div>
                                <p class="text-gray-500 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-sm text-gray-600 flex items-center justify-between">
                <span>‡πÅ‡∏™‡∏î‡∏á <span id="tableCount" class="font-semibold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                <span id="filterStatus" class="text-blue-600"></span>
            </div>
        </div>

    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        let allData = [];
        let filteredData = [];
        let currentSangkat = 'all';

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        async function loadInitialData() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
                const sangkatResponse = await fetch(`${API_URL}/sangkat`);
                const sangkatList = await sangkatResponse.json();
                
                const sangkatFilter = document.getElementById('sangkatFilter');
                sangkatList.forEach(sangkat => {
                    const option = document.createElement('option');
                    option.value = sangkat;
                    option.textContent = sangkat;
                    sangkatFilter.appendChild(option);
                });

                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                await filterBySangkat();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Server ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà');
            }
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
        async function filterBySangkat() {
            const sangkat = document.getElementById('sangkatFilter').value;
            currentSangkat = sangkat;

            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const response = await fetch(`${API_URL}/personnel/filter?sangkat=${sangkat}`);
                filteredData = await response.json();
                allData = filteredData;

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Dashboard
                await updateDashboard(sangkat);

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                updateTable(filteredData);

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
                document.getElementById('displayCount').textContent = filteredData.length.toLocaleString();
                
                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
                const filterStatus = document.getElementById('filterStatus');
                if (sangkat === 'all') {
                    filterStatus.textContent = '';
                } else {
                    filterStatus.textContent = `üîç ‡∏Å‡∏£‡∏≠‡∏á‡πÇ‡∏î‡∏¢: ${sangkat}`;
                }

            } catch (error) {
                console.error('Error filtering data:', error);
            }
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Dashboard
        async function updateDashboard(sangkat) {
            try {
                const response = await fetch(`${API_URL}/stats?sangkat=${sangkat}`);
                const stats = await response.json();

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏Å
                document.getElementById('statTotal').textContent = stats.total.toLocaleString();
                document.getElementById('statOccupied').textContent = stats.occupied.toLocaleString();
                document.getElementById('statVacant').textContent = stats.vacant.toLocaleString();
                document.getElementById('statOccupiedPercent').textContent = stats.occupiedPercent;
                document.getElementById('statVacantPercent').textContent = stats.vacantPercent;
                document.getElementById('statMale').textContent = stats.male.toLocaleString();
                document.getElementById('statFemale').textContent = stats.female.toLocaleString();

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏¢‡∏® (Top 5)
                const rankStatsDiv = document.getElementById('rankStats');
                const topRanks = Object.entries(stats.byRank)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                rankStatsDiv.innerHTML = topRanks.map(([rank, count]) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium">${rank}</span>
                        <span class="badge badge-blue">${count} ‡∏Ñ‡∏ô</span>
                    </div>
                `).join('');

                // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (Top 5)
                const sangkatStatsDiv = document.getElementById('sangkatStats');
                const topSangkat = Object.entries(stats.bySangkat)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                sangkatStatsDiv.innerHTML = topSangkat.map(([sangkat, count]) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="font-medium text-sm">${sangkat}</span>
                        <span class="badge badge-green">${count} ‡∏Ñ‡∏ô</span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function updateTable(data) {
            const tableBody = document.getElementById('tableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-8 text-gray-500">
                            ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </td>
                    </tr>
                `;
                document.getElementById('tableCount').textContent = '0';
                return;
            }

            tableBody.innerHTML = data.map((row, index) => {
                const statusBadge = row['‡∏ß‡πà‡∏≤‡∏á'] === '‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á' 
                    ? '<span class="badge badge-green">‡∏Ñ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á</span>'
                    : '<span class="badge badge-yellow">‡∏ß‡πà‡∏≤‡∏á</span>';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${row['‡∏¢‡∏®'] || '-'}</td>
                        <td>${row['‡πÄ‡∏û‡∏®'] || '-'}</td>
                        <td>${row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '-'}</td>
                        <td>${row['‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'] || '-'}</td>
                        <td>${row['‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î'] || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${row['‡∏ß‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏à‡∏∏‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏±‡∏ï‡∏£'] || '-'}</td>
                        <td>${row['‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì'] || '-'}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('tableCount').textContent = data.length.toLocaleString();
        }

        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function searchTable() {
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            
            if (searchText === '') {
                updateTable(allData);
                return;
            }

            const filtered = allData.filter(row => {
                return (
                    (row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] && row['‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'].toLowerCase().includes(searchText)) ||
                    (row['‡∏¢‡∏®'] && row['‡∏¢‡∏®'].toLowerCase().includes(searchText)) ||
                    (row['‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'] && row['‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'].toLowerCase().includes(searchText)) ||
                    (row['‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î'] && row['‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î'].toLowerCase().includes(searchText))
                );
            });

            updateTable(filtered);
        }

        // Export to Excel (simple CSV format)
        function exportToExcel() {
            const csv = convertToCSV(filteredData);
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const sangkatName = currentSangkat === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : currentSangkat;
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•_${sangkatName}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(row => {
                return headers.map(header => {
                    const value = row[header] || '';
                    return `"${value}"`;
                }).join(',');
            });
            
            return [headers.join(','), ...rows].join('\n');
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        loadInitialData();
    </script>

</body>
</html>
